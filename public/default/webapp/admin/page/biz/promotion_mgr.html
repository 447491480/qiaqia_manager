<div id="biz_promotion_list_panel">
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 10px;">
        <legend>我的活动</legend>
    </fieldset>

    <blockquote class="layui-elem-quote">
        <div>
            <button class="layui-btn layui-btn-small"><i class="layui-icon">&#xe608;</i> 新增</button>
        </div>
    </blockquote>

    <div style="margin-top: 10px;">
        <table id="biz_promotion_list_grid" class="jqgrid-table"></table>
        <div id="biz_promotion_list_grid_pager"></div>
    </div>
</div>

<div id="biz_promotion_edit_panel" style="display: none;">
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 10px;">
        <legend>新增/修改活动</legend>
    </fieldset>
    <blockquote class="layui-elem-quote">
        <div>
            <button class="layui-btn layui-btn-small"><i class="layui-icon">&#xe603;</i> 返回我的活动</button>
        </div>
    </blockquote>
    <form class="layui-form layui-form-pane" action="javascript:;">
        <div class="layui-form-item">
            <label class="layui-form-label">活动名称</label>
            <div class="layui-input-inline">
                <input type="text" lay-verify="required" name="PromotionTitle" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item " pane="">
            <label class="layui-form-label">活动类型</label>
            <div class="layui-input-block">
                <input lay-filter="biz_promotion_type_radio" type="radio" name="PromotionType" data-i="0"
                       value="DISCOUNT" title="折扣" checked="">
                <input lay-filter="biz_promotion_type_radio" type="radio" name="PromotionType" data-i="1"
                       value="FULL_MINUS" title="满减">
                <input lay-filter="biz_promotion_type_radio" type="radio" name="PromotionType" data-i="2" value="GIFT"
                       title="搭赠">
            </div>
        </div>
        <div style="position:relative;top: -15px;border-right: 1px solid #e6e6e6;border-left: 1px solid #e6e6e6;border-bottom: 1px solid #e6e6e6;">
            <div style="padding: 5px;">
                <div class="promotion-gift">
                    <label class="">请输入折扣(0.01~0.99)</label>
                    <div class="layui-input-inline">
                        <input type="text" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div style="display: none;" class="promotion-gift">
                    <div>

                    </div>

                    <div>
                        <button id="biz_promotion_add_full_minus" class="layui-btn layui-btn-small"><i
                                class="layui-icon">&#xe608;</i>点击添加满减阶段
                        </button>
                    </div>
                </div>

                <div style="display: none;padding: 5px;" class="promotion-gift">
                    <div class="promotion-gift-num" style="margin-bottom: 5px;">
                        <label class="">满</label>
                        <div class="layui-input-inline">
                            <input type="text" autocomplete="off" style="width: 50px;" value="" class="layui-input">
                        </div>
                        <span>箱，赠</span>
                        <div class="layui-input-inline">
                            <input type="text" value="" autocomplete="off" style="width: 50px;" class="layui-input">
                        </div>
                        <span>箱</span>
                    </div>
                    <div style="margin-bottom: 5px;" class="promotion-buttons">
                    </div>

                    <div>
                        <button id="biz_promotion_select_gift_goods" class="layui-btn layui-btn-small"><i
                                class="layui-icon">&#xe608;</i>点击选择搭赠商品
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">费用比例</label>
            <div class="layui-input-inline">

            </div>
        </div>
        <div style="position:relative;top: -15px;border-right: 1px solid #e6e6e6;border-left: 1px solid #e6e6e6;border-bottom: 1px solid #e6e6e6;">
            <div class="promotion-gift-funds" style="margin-bottom: 5px;">
                <label class="">上级承担(0~100)</label>
                <div class="layui-input-inline">
                    <input type="text" autocomplete="off" style="width: 50px;" value="" class="layui-input">
                </div>
                <span>；下级承担(0~100)</span>
                <div class="layui-input-inline">
                    <input type="text" value="" autocomplete="off" style="width: 50px;" class="layui-input">
                </div>
            </div>
        </div>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">选择参与厂家</label>
            <div class="layui-input-block">
                <input lay-filter="biz_promotion_shop_radio" type="radio" name="PromotionShop" data-i="0"
                       value="REGION" title="区域" checked="">
                <input lay-filter="biz_promotion_shop_radio" type="radio" name="PromotionShop" data-i="1"
                       value="BU" title="BU">
            </div>

            <div  style="border-right: 1px solid #e6e6e6;border-left: 1px solid #e6e6e6;border-bottom: 1px solid #e6e6e6;">
                <div id="biz_promotion_shop_select" style="display: none;padding: 5px;">
                    <div style="margin-bottom: 5px;" class="promotion-buttons">
                    </div>

                    <div style="display: none;">
                        <button id="biz_promotion_select_shop" class="layui-btn layui-btn-small"><i class="layui-icon">
                            &#xe608;</i>点击选择参与厂家
                        </button>
                    </div>
                </div>
                <div id="biz_promotion_shop_tree" style="display: none">
                    <ul id="biz_promotion_scope_tree" class="ztree" style="height: 200px;overflow-y: scroll;
            border-right: 1px solid #e6e6e6;border-left: 1px solid #e6e6e6;border-bottom: 1px solid #e6e6e6;">
                    </ul>
                </div>

            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">受益角色</label>
            <div class="layui-input-block"
                 style="height:36px;border-right: 1px solid #e6e6e6;border-top: 1px solid #e6e6e6;border-bottom: 1px solid #e6e6e6;">
                <input lay-skin="primary" type="checkbox" name="TargetRole[0]" value="3" title="分销商" >
                <input lay-skin="primary" type="checkbox" name="TargetRole[1]" value="4" title="门店" >
            </div>
        </div>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">选择参加活动商品</label>

            <div style="border-right: 1px solid #e6e6e6;border-left: 1px solid #e6e6e6;border-bottom: 1px solid #e6e6e6;">
                <div style="padding: 5px;">
                    <div style="margin-bottom: 5px;" class="promotion-buttons">
                    </div>

                    <div>
                        <button id="biz_promotion_select_goods" class="layui-btn layui-btn-small"><i class="layui-icon">
                            &#xe608;</i>点击选择参与活动商品
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">有效期</label>
            <div class="layui-input-inline">
                <input name="StartTime" lay-verify="datetime" class="layui-input" placeholder="开始日"
                       id="promotion_start_time">
            </div>
            <div class="layui-input-inline">
                <input name="EndTime" lay-verify="datetime" class="layui-input" placeholder="截止日"
                       id="promotion_end_time">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">优先级</label>
            <div class="layui-input-inline">
                <input type="number" lay-verify="number" name="Priority" autocomplete="off" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit="" lay-filter="biz_promotion_edit_confirm" onclick="return false">
                    立即提交
                </button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</div>

<div class="promotion-pop-window" style="display: none;">
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 10px;">
        <legend>选择搭赠商品</legend>
    </fieldset>

    <blockquote class="layui-elem-quote">
        <div>
            <button class="layui-btn layui-btn-small"><i class="layui-icon">&#xe603;</i> 返回我的活动</button>
        </div>
    </blockquote>

    <div style="margin-top: 10px;">
        <table id="biz_promotion_gift_goods_list_grid" class="jqgrid-table"></table>
        <div id="biz_promotion_gift_goods_list_grid_pager"></div>
    </div>
</div>
<div class="promotion-pop-window" style="display: none;">
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 10px;">
        <legend>选择参与商家</legend>
    </fieldset>

    <blockquote class="layui-elem-quote">
        <div>
            <button class="layui-btn layui-btn-small"><i class="layui-icon">&#xe603;</i> 返回我的活动</button>
        </div>
    </blockquote>

    <div style="margin-top: 10px;">
        <table id="biz_promotion_shop_list_grid" class="jqgrid-table"></table>
        <div id="biz_promotion_shop_list_grid_pager"></div>
    </div>
</div>
<div class="promotion-pop-window" style="display: none;">
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 10px;">
        <legend>选择活动商品</legend>
    </fieldset>

    <blockquote class="layui-elem-quote">
        <div>
            <button class="layui-btn layui-btn-small"><i class="layui-icon">&#xe603;</i> 返回我的活动</button>
        </div>
    </blockquote>

    <div style="margin-top: 10px;">
        <table id="biz_promotion_goods_list_grid" class="jqgrid-table"></table>
        <div id="biz_promotion_goods_list_grid_pager"></div>
    </div>
</div>

<style type="text/css">
    .promotion-buttons button {
        margin-left: 10px;
        margin-bottom: 5px;
    }
</style>

<script type="text/javascript">
    layui.use(['commonUtil', 'form', 'ajaxUtil', 'laydate', 'element', 'validationUtil'], function () {
        var commonUtil = layui.commonUtil;
        var form = layui.form();
        var ajaxUtil = layui.ajaxUtil;
        var laydate = layui.laydate;
        var validationUtil = layui.validationUtil;

        var urls = {};
        urls.biz_promotion_query = '/admin/promotion/query-all';
        urls.biz_promotion_save = '/admin/promotion/save';
        urls.biz_promotion_delete = '/admin/promotion/delete';
        urls.biz_promotion_detail = '/admin/promotion/promotion-detail';
        urls.biz_goods_query = '/admin/goods/query-all';
        urls.biz_relation_query = '/admin/user/relation-list';
        urls.biz_nodes_query = '/admin/tree/nodes-query';
        urls.biz_shop_query = '/admin/shop/get-subshops';
        urls.biz_regionshop_query = '/admin/shop/get-regionshops';

        var controls = {};
        controls.biz_promotion_list_panel = $('#biz_promotion_list_panel');
        controls.biz_promotion_edit_panel = $('#biz_promotion_edit_panel');
        controls.biz_promotion_select_gift_goods = $('#biz_promotion_select_gift_goods');
        controls.biz_promotion_select_shop = $('#biz_promotion_select_shop');
        controls.biz_promotion_select_scope = $('#biz_promotion_select_scope');
        controls.biz_promotion_select_goods = $('#biz_promotion_select_goods');
        controls.biz_promotion_add_full_minus = $('#biz_promotion_add_full_minus');
        controls.promotion_pop_windows = $('.promotion-pop-window');

        var M = {};
        M.MODIFY_STATUS = false;
        M.DATA = null;
        var T = null;
        var G = null;
        var start = {
            min: laydate.now(),
            max: '2099-06-16 23:59:59',
            format: 'YYYY-MM-DD hh:mm:ss',
            istime: true,
            istoday: true,
            choose: function (date) {
                end.min = date;         //开始日选好后，重置结束日的最小日期
                end.start = date;       //将结束日的初始值设定为开始日
            }
        };

        var end = {
            min: laydate.now(),
            max: '2099-06-16 23:59:59',
            format: 'YYYY-MM-DD hh:mm:ss',
            istoday: true,
            istime: true,
            choose: function (date) {
                start.max = date;      //结束日选好后，重置开始日的最大日期
            }
        };

        var settingTree = {
            view: {
                selectedMulti: false
            },
            check: {
                enable: true,
                chkboxType: {"Y":"ps", "N":"ps"}
            },

            data: {
                simpleData: {
                    enable: true
                }
            },
            callback: {
                onCheck: zTreeOnCheck
            }
        };

        function zTreeOnCheck(event, treeId, treeNode) {
            controls.biz_promotion_select_shop.parent().prev().empty();
            var treeObj = $.fn.zTree.getZTreeObj("biz_promotion_scope_tree");
            var nodes = treeObj.getCheckedNodes();
            T = T ? T : 1;
            var type = T;
            for(var i = 0; i < nodes.length; i++)
            {
                //目前这里只展示两层，只查找第二层。
                var tempNode = nodes[i];
                for(var j=0;j<tempNode.children.length;j++){
                    var l2Node = tempNode.children[j];
                    if(l2Node.getCheckStatus().checked){
                        getShopInfo(type, l2Node.id);
                    }
                }
            }
        };

        function init() {
            bindEvent();
            loadPromotionData();
            loadGiftGoodsData();
            loadRelationData();
            loadGoodsData();
        }

        function bindEvent() {
            //自定义验证规则
            form.verify({
                datetime: [/^(?:(?!0000)[0-9]{4}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-8])|(?:0[13-9]|1[0-2])-(?:29|30)|(?:0[13578]|1[02])-31)|(?:[0-9]{2}(?:0[48]|[2468][048]|[13579][26])|(?:0[48]|[2468][048]|[13579][26])00)-02-29)\s+([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/, '时间格式不正确']
            });

            // 监听活动类型切换
            form.on('radio(biz_promotion_type_radio)', function (data) {
                var index = $(this).data('i');
                $('.promotion-gift').hide();
                $('.promotion-gift:eq(' + index + ')').show();

                if (index == 1) {
                    controls.biz_promotion_select_gift_goods.parent().prev().empty();
                    controls.biz_promotion_add_full_minus.parent().prev().empty();
                } else if (index == 2) {
                    controls.biz_promotion_select_gift_goods.parent().prev().empty();
                    $('.promotion-gift:eq(0)').find('input[type=text]:eq(0)').val('');
                } else if (index == 3) {
                    $('.promotion-gift:eq(0)').find('input[type=text]:eq(0)').val('');
                    controls.biz_promotion_add_full_minus.parent().prev().empty();
                }

                return false;
            });

            form.on('radio(biz_promotion_shop_radio)', function (data) {
                var index = $(this).data('i');
                if (index == 0) {
                    T = 1;
                    //controls.biz_promotion_select_shop.parent().prev().empty();
                    destroyTree();
                    //$('#biz_promotion_shop_select').hide();
                    loadTree(0);
                    $('#biz_promotion_shop_tree').show();
                } else if(index ==1) {
                    T = 2;
                    //controls.biz_promotion_select_shop.parent().prev().empty();
                    destroyTree();
                    //$('#biz_promotion_shop_select').hide();
                    loadTree(2);
                    $('#biz_promotion_shop_tree').show();
                }

            });

            $('#promotion_start_time').bind('click', function () {
                start.elem = this;
                laydate(start);
            });

            $('#promotion_end_time').bind('click', function () {
                end.elem = this;
                laydate(end);
            });

            // 监听提交
            form.on('submit(biz_promotion_edit_confirm)', function (data) {
                var args = data.field;

                if (args.PromotionType == "DISCOUNT") {
                    var discount = $('.promotion-gift:eq(0)').find('input[type=text]:eq(0)').val();
                    if (!validationUtil.isDiscount(discount)) {
                        return commonUtil.toast('请输入正确的折扣范围(0.01~0.99)');
                    }

                    args.PromotionContent = discount;
                } else if (args.PromotionType == "FULL_MINUS") {
                    var content = [];
                    controls.biz_promotion_add_full_minus.parent().prev().find('.promotion-full-minus').each(function () {
                        var full = $.trim($(this).find('input[type=text]:eq(0)').val());
                        var minus = $.trim($(this).find('input[type=text]:eq(1)').val());

                        if (!validationUtil.isPrice(full) || !validationUtil.isPrice(minus)) {
                            return commonUtil.toast('输入正确的满减阶段价格格式');
                        }

                        content.push({full: full, minus: minus});
                    });

                    if (content.length <= 0) {
                        return commonUtil.toast('请添加一个满减阶段');
                    }

                    args.PromotionContent = JSON.stringify(content);
                } else if (args.PromotionType == "GIFT") {
                    var content = [];
                    controls.biz_promotion_select_gift_goods.parent().prev().find('button').each(function () {
                        var gid = $(this).data('gid');
                        var gname = $(this).data('gname');

                        content.push({goodsId: gid, goodsName: gname});
                    });

                    if (content.length <= 0) {
                        return commonUtil.toast('请添加一个赠品');
                    }

                    var full = controls.biz_promotion_select_gift_goods.parent().prev().prev().find('input[type=text]:eq(0)').val();
                    var minus = controls.biz_promotion_select_gift_goods.parent().prev().prev().find('input[type=text]:eq(1)').val();

                    if (!validationUtil.isPrice(full) || !validationUtil.isPrice(minus)) {
                        return commonUtil.toast('输入正确的搭赠格式');
                    }

                    args.PromotionContent = JSON.stringify({full: full, minus: minus, goodsList: content});
                }

                var shops = [];
                controls.biz_promotion_select_shop.parent().prev().find('button').each(function () {
                    var gid = $(this).data('gid');
                    var gname = $(this).data('gname');

                    shops.push({shopId: gid, shopName: gname});
                });

                args.shops = JSON.stringify(shops);

                if (!args['TargetRole[0]'] && !args['TargetRole[1]']) {
                    return commonUtil.toast('请选择受益角色');
                }

                var roles = [];
                if (args['TargetRole[0]']) {
                    roles.push(args['TargetRole[0]']);
                }

                if (args['TargetRole[1]']) {
                    roles.push(args['TargetRole[1]']);
                }
                args.roles = roles.join('|');


                var goods = [];
                controls.biz_promotion_select_goods.parent().prev().find('button').each(function () {
                    var gid = $(this).data('gid');
                    var gname = $(this).data('gname');

                    goods.push({goodsId: gid, goodsName: gname});
                });

                if (goods.length <= 0) {
                    return commonUtil.toast('请添加一个活动商品');
                }

                args.goods = JSON.stringify(goods);

                if (M.MODIFY_STATUS) {
                    args.Id = M.DATA.Id;
                }

                var fundsU = $(".promotion-gift-funds").find('input[type=text]:eq(0)').val();
                var fundsD = $(".promotion-gift-funds").find('input[type=text]:eq(1)').val();

                if (!validationUtil.isPrice(fundsU) || !validationUtil.isPrice(fundsD)) {
                    return commonUtil.toast('输入正确的经费比例格式');
                }
                if(parseFloat(fundsD) + parseFloat(fundsU) != 100){
                    return commonUtil.toast('经费比例和不等于100');
                }
                args.Funds = parseFloat(fundsD);
                console.log(args.Funds);
                ajaxUtil.doAjaxPost(urls.biz_promotion_save, args).done(function (ret) {
                    commonUtil.toast(ret.msg);

                    if (ret.status == 0) {
                        controls.biz_promotion_edit_panel.find('button:eq(0)').trigger('click');
                        refreshPromotionData();
                    }
                });

                return false;
            });

            // 点击增加
            controls.biz_promotion_list_panel.find('button:eq(0)').bind('click', function () {
                $('#biz_promotion_shop_tree').hide();
                $('#biz_promotion_shop_select').show();
                showEditPanel();
                form.render();
                loadTree(0);
                $('#biz_promotion_shop_tree').show();
            });

            // 点击返回
            controls.biz_promotion_edit_panel.find('button:eq(0)').bind('click', function () {
                controls.biz_promotion_edit_panel.find('button:eq(-1)').trigger('click');
                showListPanel();
                M.MODIFY_STATUS = false;
                M.DATA = null;
            });

            // 点击重置
            controls.biz_promotion_edit_panel.find('button:eq(-1)').bind('click', function () {
                controls.biz_promotion_select_gift_goods.parent().prev().empty();
                controls.biz_promotion_select_shop.parent().prev().empty();
                controls.biz_promotion_select_goods.parent().prev().empty();
                $('.promotion-gift').hide();
                $('.promotion-gift:eq(0)').show();
                controls.biz_promotion_add_full_minus.parent().prev().empty();

                controls.biz_promotion_edit_panel.find('input[type=checkbox]').each(function(){
                    var _self = this;
                    $(_self).removeAttr('checked');
                });

                form.render('checkbox');

            });

            // 点击选择搭赠商品
            controls.biz_promotion_select_gift_goods.bind('click', function () {
                showGiftSelectPanel();
                refreshGiftGoodsData();
            });

            // 点击选择参与商家
//            controls.biz_promotion_select_shop.bind('click', function () {
//                controls.biz_promotion_select_shop.parent().prev().empty();
//                showShopSelectPanel();
//                refreshRelation();
//            });

            // 点击选择活动商品
            controls.biz_promotion_select_goods.bind('click', function () {
                showGoodsSelectPanel();
                refreshGoodsData();
            });

            // 返回
            controls.promotion_pop_windows.find('button:eq(0)').bind('click', function () {
                G = 0;
                showEditPanel();
            });

            // 选择搭赠商品
            $("#biz_promotion_gift_goods_list_grid").on({
                'click': function () {
                    var _self = this;
                    var data = JSON.parse(decodeURIComponent($(this).data('goods')));

                    var isSelected = false;
                    controls.biz_promotion_select_gift_goods.parent().prev().find('button').each(function () {
                        if ($(this).data('gid') == data.Id) {
                            isSelected = true;
                        }
                    });

                    if (isSelected) {
                        return commonUtil.toast('已选择，不要重复选择');
                    }

                    $(_self).text('已选择');

                    controls.biz_promotion_select_gift_goods.parent().prev().append(buttonDomBuilder(data.Id, data.GoodsTitle));
                }
            }, '.biz-gift-select');

            // 删除已选择的搭赠商品
            controls.biz_promotion_select_gift_goods.parent().prev().on({
                'click': function () {
                    $(this).parent().remove();
                }
            }, '.selected-delete');

            // 删除一个满减阶段
            controls.biz_promotion_add_full_minus.parent().prev().on({
                'click': function () {
                    $(this).parent().remove();
                }
            }, '.full-minus-delete');

            // 点击添加满减阶段
            controls.biz_promotion_add_full_minus.bind('click', function () {
                controls.biz_promotion_add_full_minus.parent().prev().append(minusDomBuilder());
            });

            // 选择参与商家
            $("#biz_promotion_shop_list_grid").on({
                'click': function () {
                    var _self = this;
                    var data = JSON.parse(decodeURIComponent($(this).data('relation')));

                    var isSelected = false;
                    controls.biz_promotion_select_shop.parent().prev().find('button').each(function () {
                        if ($(this).data('gid') == data.shop.Id) {
                            isSelected = true;
                        }
                    });

                    if (isSelected) {
                        return commonUtil.toast('已选择，不要重复选择');
                    }

                    $(_self).text('已选择');

                    controls.biz_promotion_select_shop.parent().prev().append(buttonDomBuilder(data.shop.Id, data.shop.MemberName));
                }
            }, '.biz-shop-select');

            // 删除已选择的商家
            controls.biz_promotion_select_shop.parent().prev().on({
                'click': function () {
                    $(this).parent().remove();
                }
            }, '.selected-delete');

            // 选择活动商品
            $("#biz_promotion_goods_list_grid").on({
                'click': function () {
                    var _self = this;
                    var data = JSON.parse(decodeURIComponent($(this).data('goods')));

                    var isSelected = false;
                    controls.biz_promotion_select_goods.parent().prev().find('button').each(function () {
                        if ($(this).data('gid') == data.Id) {
                            isSelected = true;
                        }
                    });

                    if (isSelected) {
                        return commonUtil.toast('已选择，不要重复选择');
                    }

                    $(_self).text('已选择');

                    controls.biz_promotion_select_goods.parent().prev().append(buttonDomBuilder(data.Id, data.GoodsTitle));
                }
            }, '.biz-goods-select');

            // 删除活动商品
            controls.biz_promotion_select_goods.parent().prev().on({
                'click': function () {
                    $(this).parent().remove();
                }
            }, '.selected-delete');

            // 点击修改
            $("#biz_promotion_list_grid").on({
                'click':function(){
                    var data = JSON.parse(decodeURIComponent($(this).data('promotion')));
                    $('#biz_promotion_shop_tree').hide();
                    $('#biz_promotion_shop_select').show();
                    showEditPanel();
                    M.MODIFY_STATUS = true;
                    M.DATA = data;

                    ajaxUtil.doAjaxGet(urls.biz_promotion_detail,{id:data.Id}).done(function(ret){
                        if(ret.status == 0) {
                            controls.biz_promotion_edit_panel.find('input:eq(0)').val(data.PromotionTitle);
                            console.log(data.Funds);
                            $(".promotion-gift-funds").find('input:eq(0)').val(100 - data.Funds);
                            $(".promotion-gift-funds").find('input:eq(1)').val(data.Funds);

                            controls.biz_promotion_edit_panel.find('input[name=PromotionType]').each(function(i){
                                if(data.PromotionType == $(this).val()) {
                                    $(this).trigger('click');

                                    $('.promotion-gift').hide();
                                    $('.promotion-gift:eq(' + $(this).data('i') + ')').show();

                                    if(data.PromotionType == "DISCOUNT") {
                                        $('.promotion-gift:eq(0)').find('input[type=text]:eq(0)').val(data.PromotionContent);
                                    } else if(data.PromotionType == "FULL_MINUS") {
                                        var content = JSON.parse(data.PromotionContent);
                                        layui.each(content,function(i,o){
                                            controls.biz_promotion_add_full_minus.parent().prev().append(minusDomBuilder(o.full,o.minus));
                                        })
                                    } else if(data.PromotionType == "GIFT") {
                                        var giftContent = JSON.parse(data.PromotionContent);
                                        controls.biz_promotion_select_gift_goods.parent().prev().prev().find('input[type=text]:eq(0)').val(giftContent.full);
                                        controls.biz_promotion_select_gift_goods.parent().prev().prev().find('input[type=text]:eq(1)').val(giftContent.minus);

                                        var content = giftContent.goodsList;
                                        layui.each(content,function(i,o){
                                            controls.biz_promotion_select_gift_goods.parent().prev().append(buttonDomBuilder(o.goodsId,o.goodsName));
                                        })
                                    }
                                }

                                form.render('radio');
                            });

                            layui.each(ret.data.joiners,function(i,o){
                                if(o.PID) {
                                    controls.biz_promotion_select_shop.parent().prev().append(buttonDomBuilder(o.SID,o.shop.MemberName));
                                }
                            });

                            var roles = data.TargetRoleId.split('|');
                            controls.biz_promotion_edit_panel.find('input[type=checkbox]').each(function(){
                                var _self = this;
                                layui.each(roles,function(i,o) {
                                    if(o == $(_self).val()) {
                                        $(_self).attr('checked','');
                                    }
                                })
                            });

                            form.render('checkbox');

                            layui.each(ret.data.goods,function(i,o){
                                controls.biz_promotion_select_goods.parent().prev().append(buttonDomBuilder(o.good.GoodsId,o.good.GoodsTitle));
                            });

                            $('#promotion_start_time').val(commonUtil.getTimeString(data.StartTime,'-'));
                            $('#promotion_end_time').val(commonUtil.getTimeString(data.EndTime,'-'));

                            controls.biz_promotion_edit_panel.find('input[name=Priority]').val(data.Priority);

                            loadTree(0);
                            $('#biz_promotion_shop_tree').show();

                        } else {
                            commonUtil.toast(ret.msg);
                        }
                    });





                }
            },'.biz-promotion-modify');

            // 点击删除
            $("#biz_promotion_list_grid").on({
                'click':function(){
                    var data = JSON.parse(decodeURIComponent($(this).data('promotion')));

                    var confirmLayer = layer.confirm('确定删除？', {
                        btn: ['确定','取消'] //按钮
                    }, function(){
                        layer.close(confirmLayer);
                        ajaxUtil.doAjaxGet(urls.biz_promotion_delete,{'Id':data.Id}).done(function(ret){
                            commonUtil.toast(ret.msg);
                            if(ret.status == 0) {
                                refreshPromotionData();
                            }
                        });
                    }, function(){});
                }
            },'.biz-promotion-delete');
        }

        function buttonDomBuilder(id, name) {
            return '<button class="layui-btn layui-btn-mini layui-btn-normal" data-gid="' + id + '" data-gname="' + name + '">' + name + '<i style="margin-left: 10px;" class="layui-icon selected-delete">&#xe640;</i></button>';
        }

        function minusDomBuilder(full, minus) {
            full = full || '';
            minus = minus || '';

            return '<div class="promotion-full-minus" style="margin-bottom: 5px;">' +
                '    <label class="">满</label>' +
                '    <div class="layui-input-inline">' +
                '        <input type="text" autocomplete="off" value="' + full + '" class="layui-input">' +
                '    </div>' +
                '    <span>减</span>' +
                '    <div class="layui-input-inline">' +
                '        <input type="text" value="' + minus + '" autocomplete="off" class="layui-input">' +
                '    </div>' +
                '    <button class="layui-btn layui-btn-small layui-btn-normal full-minus-delete"><i' +
                '            class="layui-icon">&#xe640;</i>删除' +
                '    </button>' +
                '</div>';
        }

        function showEditPanel() {
            controls.biz_promotion_edit_panel.show();
            controls.biz_promotion_list_panel.hide();
            controls.promotion_pop_windows.hide();
        }

        function showListPanel() {
            controls.biz_promotion_edit_panel.hide();
            controls.biz_promotion_list_panel.show();
            controls.promotion_pop_windows.hide();
        }

        function showGiftSelectPanel() {
            controls.biz_promotion_edit_panel.hide();
            controls.biz_promotion_list_panel.hide();
            controls.promotion_pop_windows.hide();
            controls.promotion_pop_windows.eq(0).show();
        }

        function showShopSelectPanel() {
            controls.biz_promotion_edit_panel.hide();
            controls.biz_promotion_list_panel.hide();
            controls.promotion_pop_windows.hide();
            controls.promotion_pop_windows.eq(1).show();
        }

        function showGoodsSelectPanel() {
            controls.biz_promotion_edit_panel.hide();
            controls.biz_promotion_list_panel.hide();
            controls.promotion_pop_windows.hide();
            controls.promotion_pop_windows.eq(2).show();
        }

        function refreshGiftGoodsData(data) {
            data = data || {};
            var page = $("#biz_promotion_gift_goods_list_grid").getGridParam('page'); // current page
            var rows = $("#biz_promotion_gift_goods_list_grid").getGridParam('rows'); // rows
            $("#biz_promotion_gift_goods_list_grid").jqGrid('setGridParam', {
                page: page,
                rows: rows,
                postData: data
            }).trigger("reloadGrid")
        }

        function loadGiftGoodsData() {
            $("#biz_promotion_gift_goods_list_grid").jqGrid({
                colModel: [
                    {label: '商品名称', name: 'GoodsTitle', align: 'center'},
                    {label: '商品简称', name: 'GoodsShortTitle', align: 'center'},
                    {label: '商品原价', name: 'GoodsOriginalPrice', align: 'center'},
                    {label: '商品售价', name: 'GoodsSalePrice', align: 'center'},
                    {label: '商品供货价', name: 'GoodsSupplyPrice', align: 'center'},
                    {
                        label: '限量', name: 'LimitCount', align: 'center', formatter: function (cell, option, row) {
                        return row.LimitCount + '~' + row.MaxCount;
                    }
                    },
                    {
                        label: '操作', align: 'center', formatter: function (cellValue, options, rowObject) {
                        var _dom = '';
                        var isSelected = false;
                        controls.biz_promotion_select_gift_goods.parent().prev().find('button').each(function () {
                            if ($(this).data('gid') == rowObject.Id) {
                                isSelected = true;
                                return false;
                            }
                        });

                        if (isSelected) {
                            _dom = '<span data-goods="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-gift-select">已选择</span>';
                        } else {
                            _dom = '<span data-goods="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-gift-select">选择</span>';
                        }

                        return _dom;
                    }
                    }
                ],
                datatype: 'json',
                url: urls.biz_goods_query,
                rowNum: 10,
                rowList: [10, 20, 30],
                viewrecords: true, // show the current page, data rang and total records on the toolbar
                height: true,
                fitColumns: true,
                width: true,
                autowidth: true,
                shrinkToFit: true,
                ajaxGridOptions: {
                    dataFilter: function (ret) {
                        var retObj = JSON.parse(ret);
                        if (retObj.status == 0) {
                            return JSON.stringify(retObj.data);
                        } else {
                            commonUtil.toast(retObj.msg);
                        }
                    }
                },
                pager: "#biz_promotion_gift_goods_list_grid_pager"
            });

            // 初始化宽宽，用于自适应宽度
            $("#biz_promotion_gift_goods_list_grid").setGridWidth($("#admin-tab-container").width() - 10, true);
        }

        function refreshRelation(data) {
            data = data || {};
            var page = $("#biz_promotion_shop_list_grid").getGridParam('page'); // current page
            var rows = $("#biz_promotion_shop_list_grid").getGridParam('rows'); // rows
            $("#biz_promotion_shop_list_grid").jqGrid('setGridParam', {
                page: page,
                rows: rows,
                postData: data
            }).trigger("reloadGrid");
        }

        function loadRelationData() {
            $("#biz_promotion_shop_list_grid").jqGrid({
                colModel: [
                    {
                        label: '客户名称',
                        name: 'MemberName',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return rowObject.shop.MemberName;
                        }
                    },
                    {
                        label: '地址',
                        name: 'Address',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return commonUtil.filter(rowObject.shop.Address);
                        }
                    },
                    {
                        label: '地区',
                        name: 'MemberArea',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return commonUtil.filter(rowObject.shop.MemberArea);
                        }
                    },
                    {
                        label: 'BU',
                        name: 'MemberBU',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return commonUtil.filter(rowObject.shop.MemberBU);
                        }
                    },
                    {
                        label: '总积分',
                        name: 'Points',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return rowObject.shop.Points;
                        }
                    },
                    {
                        label: '总资产',
                        name: 'Asset',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return rowObject.shop.Asset;
                        }
                    },
                    {
                        label: '操作', align: 'center', formatter: function (cellValue, options, rowObject) {
                        var _dom = '';
                        var isSelected = false;
                        controls.biz_promotion_select_shop.parent().prev().find('button').each(function () {
                            if ($(this).data('gid') == rowObject.shop.Id) {
                                isSelected = true;
                                return false;
                            }
                        });

                        if (isSelected) {
                            _dom = '<span data-relation="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-shop-select">已选择</span>';
                        } else {
                            _dom = '<span data-relation="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-shop-select">选择</span>';
                        }
                        return _dom;
                    }
                    }
                ],
                datatype: 'json',
                url: urls.biz_relation_query,
                rowNum: 10,
                rowList: [10, 20, 30],
                viewrecords: true, // show the current page, data rang and total records on the toolbar
                height: true,
                fitColumns: true,
                width: true,
                autowidth: true,
                shrinkToFit: true,
                ajaxGridOptions: {
                    dataFilter: function (ret) {
                        var retObj = JSON.parse(ret);
                        if (retObj.status == 0) {
                            return JSON.stringify(retObj.data);
                        } else {
                            commonUtil.toast(retObj.msg);
                        }
                    }
                },
                pager: "#biz_promotion_shop_list_grid_pager"
            });

            // 初始化宽宽，用于自适应宽度
            $("#biz_promotion_shop_list_grid").setGridWidth($("#admin-tab-container").width() - 10, true);
        }

        function refreshGoodsData(data) {
            data = data || {};
            var page = $("#biz_promotion_goods_list_grid").getGridParam('page'); // current page
            var rows = $("#biz_promotion_goods_list_grid").getGridParam('rows'); // rows
            $("#biz_promotion_goods_list_grid").jqGrid('setGridParam', {
                page: page,
                rows: rows,
                postData: data
            }).trigger("reloadGrid")
        }

        function loadGoodsData() {
            $("#biz_promotion_goods_list_grid").jqGrid({
                colModel: [
                    {label: '商品名称', name: 'GoodsTitle', align: 'center'},
                    {label: '商品简称', name: 'GoodsShortTitle', align: 'center'},
                    {label: '商品原价', name: 'GoodsOriginalPrice', align: 'center'},
                    {label: '商品售价', name: 'GoodsSalePrice', align: 'center'},
                    {label: '商品供货价', name: 'GoodsSupplyPrice', align: 'center'},
                    {
                        label: '限量', name: 'LimitCount', align: 'center', formatter: function (cell, option, row) {
                        return row.LimitCount + '~' + row.MaxCount;
                    }
                    },
                    {
                        label: '创建者', name: 'OwnerId', align: 'center', formatter: function (cell, option, row) {
                        return commonUtil.filter(row.shop.MemberName);
                    }
                    },
                    {
                        label: '创建时间',
                        name: 'CreateTime',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return commonUtil.getTimeString(cellValue);
                        }
                    },
                    {
                        label: '操作', align: 'center', formatter: function (cellValue, options, rowObject) {
                        var _dom = '';

                        var isSelected = false;
                        controls.biz_promotion_select_goods.parent().prev().find('button').each(function () {
                            if ($(this).data('gid') == rowObject.Id) {
                                isSelected = true;
                                return false;
                            }
                        });

                        if (isSelected) {
                            _dom += '<span data-goods="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-goods-select">已选择</span>';
                        } else {
                            _dom += '<span data-goods="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-goods-select">选择</span>';
                        }

                        return _dom;
                    }
                    }
                ],
                datatype: 'json',
                url: urls.biz_goods_query,
                rowNum: 10,
                rowList: [10, 20, 30],
                viewrecords: true, // show the current page, data rang and total records on the toolbar
                height: true,
                fitColumns: true,
                width: true,
                autowidth: true,
                shrinkToFit: true,
                ajaxGridOptions: {
                    dataFilter: function (ret) {
                        var retObj = JSON.parse(ret);
                        if (retObj.status == 0) {
                            return JSON.stringify(retObj.data);
                        } else {
                            commonUtil.toast(retObj.msg);
                        }
                    }
                },
                pager: "#biz_promotion_goods_list_grid_pager"
            });

            // 初始化宽宽，用于自适应宽度
            $("#biz_promotion_goods_list_grid").setGridWidth($("#admin-tab-container").width() - 10, true);
        }

        function refreshPromotionData(data) {
            data = data || {};
            var page = $("#biz_promotion_list_grid").getGridParam('page'); // current page
            var rows = $("#biz_promotion_list_grid").getGridParam('rows'); // rows
            $("#biz_promotion_list_grid").jqGrid('setGridParam', {
                page: page,
                rows: rows,
                postData: data
            }).trigger("reloadGrid")
        }

        function loadPromotionData() {
            $("#biz_promotion_list_grid").jqGrid({
                colModel: [
                    {
                        label: '活动名称', name: 'PromotionTitle', align: 'center'
                    },
                    {
                        label: '活动类型',
                        name: 'PromotionTitle',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            if(rowObject.PromotionType=='DISCOUNT') {
                                return '折扣';
                            } else if(rowObject.PromotionType=='FULL_MINUS') {
                                return '满减';
                            } else if(rowObject.PromotionType=='GIFT') {
                                return '搭赠';
                            } else {
                                return rowObject.PromotionType;
                            }
                        }
                    },
                    {
                        label: '优先级', name: 'Priority', align: 'center'
                    },
                    {
                        label: '开始时间',
                        name: 'StartTime',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return commonUtil.getTimeString(cellValue);
                        }
                    },
                    {
                        label: '结束时间',
                        name: 'EndTime',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return commonUtil.getTimeString(cellValue);
                        }
                    },
                    {
                        label: '创建时间',
                        name: 'CreateTime',
                        align: 'center',
                        formatter: function (cellValue, options, rowObject) {
                            return commonUtil.getTimeString(cellValue);
                        }
                    },
                    {
                        label: '操作', align: 'center', formatter: function (cellValue, options, rowObject) {
                        var _dom = '';

                        _dom += '<span data-promotion="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-promotion-modify">修改</span>&nbsp;&nbsp;<span data-promotion="' + encodeURIComponent(JSON.stringify(rowObject)) + '" href="javascript:;" class="my-grid-a-span biz-promotion-delete">删除</span>';

                        return _dom;
                    }
                    }
                ],
                datatype: 'json',
                url: urls.biz_promotion_query,
                rowNum: 10,
                rowList: [10, 20, 30],
                viewrecords: true, // show the current page, data rang and total records on the toolbar
                height: true,
                fitColumns: true,
                width: true,
                autowidth: true,
                shrinkToFit: true,
                ajaxGridOptions: {
                    dataFilter: function (ret) {
                        var retObj = JSON.parse(ret);
                        if (retObj.status == 0) {
                            return JSON.stringify(retObj.data);
                        } else {
                            commonUtil.toast(retObj.msg);
                        }
                    }
                },
                pager: "#biz_promotion_list_grid_pager"
            });

            // 初始化宽宽，用于自适应宽度
            $("#biz_promotion_list_grid").setGridWidth($("#admin-tab-container").width() - 10, true);
        }

        function loadTree(type) {
            ajaxUtil.doAjaxGet(urls.biz_nodes_query,{type: type}).done(function (ret) {
                if (ret.status != 0) {
                    return commonUtil.toast('初始化列表失败');
                }
                var treenode = [];
                var nodes = [];
                console.log(ret.data);
                if(type != 2){
                    nodes = ret.data;
                }else{
                    //按照BU选择时，只筛允许筛选销售事业部下面的，故在此写死，不用做一个设置页面。
                    for(var i=0;i<ret.data.length;i++){
                        var _nodeTemp = ret.data[i];
                        if(_nodeTemp.Level <= 1){
                            console.log(_nodeTemp.Name);
                            continue;
                        }
                        if(_nodeTemp.Position.indexOf("55946cb0-2563-11e7-9498-23354e0e82c6") > 0){
                            nodes.push(_nodeTemp);
                        }
                    }
                }

                for (var i = 0; i < nodes.length; i++) {
                    var node = {};
//                    if (nodes[i].Level < 2) {
//                        <!--var names = nodes[i].Name.split('|');-->
//                        <!--node.name = names[nodes[i].Level];-->
                        node.name = nodes[i].Name;
                        node.id = nodes[i].Id;
                        node.pId = nodes[i].ParentId;
                        treenode.push(node);
//                    }
                }
                $.fn.zTree.init($("#biz_promotion_scope_tree"), settingTree, treenode);
            });
        }

        function destroyTree() {
            var zTreeObj = $.fn.zTree.getZTreeObj("biz_promotion_scope_tree");
            if (zTreeObj) {
                zTreeObj.destroy();
            }
        }

        function getShopInfo(type, key) {
            var data = {};
            if (type == 1)
                data.MemberArea = key;
            else if (type == 2)
                data.MemberBU = key;
            ajaxUtil.doAjaxGet(urls.biz_shop_query, data).done(function (ret) {
                for (var i = 0; i < ret.data.length; i++) {
                    controls.biz_promotion_select_shop.parent().prev()
                        .append(buttonDomBuilder(ret.data[i].shop.Id, ret.data[i].shop.MemberName));

                }
            });
        }

        function getRegionShop(keyword) {
            ajaxUtil.doAjaxGet(urls.biz_regionshop_query, {keyword:keyword}).done(function (ret) {
                for (var i = 0; i < ret.data.length; i++) {
                    controls.biz_promotion_select_shop.parent().prev()
                        .append(buttonDomBuilder(ret.data[i].shop.Id, ret.data[i].shop.MemberName));

                }
            });
        }

        (function () {
            init();
        })();
    });
</script>